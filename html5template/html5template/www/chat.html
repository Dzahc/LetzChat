<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<link rel="apple-touch-icon-precomposed" sizes="114x114" href="images/splash/splash-icon.png">
<link rel="apple-touch-startup-image" href="images/splash/splash-screen.png" 			media="screen and (max-device-width: 320px)" />
<link rel="apple-touch-startup-image" href="images/splash/splash-screen@2x.png" 		media="(max-device-width: 480px) and (-webkit-min-device-pixel-ratio: 2)" />
<link rel="apple-touch-startup-image" sizes="640x1096" href="images/splash/splash-screen@3x.png" />

<title>LetzChat - Version 1.0a</title>

<link href="styles/style.css"     		rel="stylesheet" type="text/css">
<link href="styles/menus-background.css" rel="stylesheet" type="text/css" id="pagestyle">
<link href="styles/framework.css" 		rel="stylesheet" type="text/css">
<link href="styles/owl.carousel.css" 	 rel="stylesheet" type="text/css">
<link href="styles/owl.theme.css" 		rel="stylesheet" type="text/css">
<link href="styles/swipebox.css"		 rel="stylesheet" type="text/css">
<link href="styles/colorbox.css"		 rel="stylesheet" type="text/css">
<link rel="stylesheet" href="css/chat.css">

<script type="text/javascript" src="scripts/jquery.js"></script>
<script type="text/javascript" src="scripts/jqueryui.js"></script>
<script type="text/javascript" src="scripts/owl.carousel.min.js"></script>
<script type="text/javascript" src="scripts/jquery.swipebox.js"></script>
<script type="text/javascript" src="scripts/colorbox.js"></script>
<script type="text/javascript" src="scripts/snap.js"></script>
<script type="text/javascript" src="scripts/contact.js"></script>
<script type="text/javascript" src="scripts/custom.js"></script>
<script type="text/javascript" src="scripts/framework.js"></script>
<script type="text/javascript" src="scripts/framework.launcher.js"></script>

<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-storage.js"></script>
<script type="text/javascript" src="scripts/firebaseUtils.js"></script>

<script type="text/javascript">
function swapStyleSheet(sheet){
	document.getElementById('pagestyle').setAttribute('href', sheet);
}
</script>

<script>   //get paramter from URL
var query = window.location.search.substring(1);
console.log(query)
var paramurl = query.split("=");
var convoid = paramurl[1];
console.log(convoid);
</script>


    <script type="text/javascript" >
    var user_id = localStorage.getItem("userId");
    var conversation_id = convoid;
    var dateTime = new Date().toString();
    var language = localStorage.getItem("device_language");
    var text = "";
    var $ = jQuery.noConflict();
    var messageForm = document.getElementById('messageForm');
      function onMessageSubmitted() {
        console.log("function called");
        text = document.getElementById('message').value;

        console.log("testing code ", localStorage.getItem("device_language"));
        console.log("the time is " + dateTime);
        console.log("the language is " + language);
        console.log("the message is " + text);
        var messageRef = firebase.database().ref('messages/');
        if (language===null){
            language="";
        }
        if (!conversation_id){
            conversation_id="";
        }
        if (!dateTime){
            dateTime="";
        }
        if (!text){
            text="";
        }
        if (!user_id){
            user_id="";
        }



        messageRef.push({
          conversation_id: conversation_id,
          dateTime: dateTime,
          language: language,
          text: text,
          user_id: user_id
        });
        return false;
        }
    </script>

		<script> //pull conversation
            var $ = jQuery.noConflict();
		    var ref = firebase.database().ref("messages");
            var messageArray = new Array();
		    ref.orderByChild("conversation_id").equalTo(convoid).on("child_added", function(snapshot) {
		    //    console.log("the snapshot ", snapshot.key);
            //    console.log("current message array ", messageArray)
               //messageArray.push(snapshot.key);

               var index = snapshot.key.toString();

               messageArray.push(index);

           });


           //console.log(messageArray);

          // for each (var item in messageArray) {

               messageArray.forEach( function(currentValue, index, messageArray){

                    console.log("Value " + currentValue);

               });



           //}
            // for (i=0; i<messageArray.length; i++){

            //$(messageArray).each( function( i, value ){
                //console.log(i);
                //console.log(value);
                /*var userid;
                var text;
                var dateTime;
                    var ref2 = firebase.database().ref("messages");
                    console.log(messageArray[i]);
                    ref2.orderByKey().equalTo(messageArray[i]).on("child_added", function(snapshot) {
                       snapshot.forEach(function(data) {
                         for (key in data){
                             if (data.key=="text"){
                                 text = data.val()
                                 console.log("the text is ", text);
                             }
                             if (data.key=="user_id"){
                                     var ref3 = firebase.database().ref("userId");
                                     userid = data.val();
                                     console.log("the user id is ", userid);
                                     ref3.orderByKey().equalTo(data.val()).on("child_added", function(snapshot) {
                                        snapshot.forEach(function(data) {

                                          if(data.key=="displayName"){
                                            var user = data.val();
                                            console.log("the user is ", user);
                                          }
                                        })
                                       });
                                   }
                               if(data.key=="dateTime"){
                                   dateTime = data.val()
                                   console.log(dateTime);
                               }
                           }
                       });
                       console.log('trying to render message');
                       console.log("Current user is ", localStorage.getItem("userId"));
                       console.log("the userid is ", userid);
                       console.log("the text is ", text);
                       if(userid == localStorage.getItem("userId")){
                           $( document ).ready(function() {
                               $(".chat").append('<li class="self"><div class="avatar"><img src="https://i.imgur.com/DY6gND0.png" draggable="false"/></div><div class="msg"><p>' + text + ' </p><time>'+dateTime + '</time></div></li>')
                           })}
                           else{
                            $( document ).ready(function() {
                                $(".chat").append('<li class="other"><div class="avatar"><img src="https://i.imgur.com/DY6gND0.png" draggable="false"/></div><div class="msg"><p>' + text + ' </p><time>'+dateTime + '</time></div></li>')
                            });
                           }
                  });*/
             // });


		</script>


</head >
        <body>



            <div id="preloader">
                <div id="status">
                    <p class="center-text">
                        Loading the content...
            <em>Loading depends on your connection speed!</em>
                    </p>
                </div>
            </div>



<div class="clear"></div>

            <div class="all-elements">
                <div class="content-header">
                    <!-- Activate the side nav button if necessary -->
                    <!--a href="#" class="deploy-sidebar"></a-->
                    <img class="logo" style="margin-top: 10px;" src="images/misc/letzchat_logo_white.png" width="92" alt="img">
                        <a href="profile-view.html" class="deploy-contact"></a>
                        <div class="clear"></div>
    </div>

    <!-- Include the side nav if necessary -->
    <!--div data-include="side-nav"></div-->


    <div id="content" class="page-content">

        <div class="content">

			<div class="decoration"></div>

			<div class="container">
                <div class="menu">
                        <div class="back"><i class="fa fa-chevron-left"></i> <img src="https://i.imgur.com/DY6gND0.png" draggable="false"/></div>
                        <div class="name">Alex</div>
                        <div class="last">18:09</div>
                    </div>
                <ol class="chat">
                <li class="other">
                    <div class="avatar"><img src="https://i.imgur.com/DY6gND0.png" draggable="false"/></div>
                  <div class="msg">
                    <p>Hello!</p>
                    <p>Lorem ipsum dolor sit amet. <emoji class="pizza"/></p>
                    <time>20:17</time>
                  </div>
                </li>
                <li class="self">
                    <div class="avatar"><img src="https://i.imgur.com/HYcn9xO.png" draggable="false"/></div>
                  <div class="msg">
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. <emoji class="books"/></p>
                    <p>Lorem ipsum dolor.</p>
                    <time>20:18</time>
                  </div>
                </li>
                </ol>
                <form onsubmit="return onMessageSubmitted()" id="messageForm" method="post">
                  <input id="message" type="text" name="message" class="textarea" type="text" placeholder="Type here!"/><div class="emojis"></div>
                  <input type="hidden" onkeydown="if (event.keyCode == 13) { this.form.submit()}" name="" value="">
                </form>
			</div>

				<div class="decoration"></div>


				<div style="height:60px"></div>
        </div>
    </div>
</div>

<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="scripts/platformOverrides.js"></script>
<script type="text/javascript" src="scripts/hexagon.js"></script>

</body>
</html>
