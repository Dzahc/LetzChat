 <script type="text/javascript" src="scripts/translate.js"></script>
<script>
    
    var participantsref = firebase.database().ref("participants");
    var userArray = [];
    var othersArray = [];
    var userref = firebase.database().ref("userId"); 
    var convref = firebase.database().ref("conversations"); 
    var msgref = firebase.database().ref("messages"); 

    var user = JSON.parse(localStorage.getItem("user"));
    var user_id = localStorage.getItem("userId");

    if ( user_id.length < 5 ) {

        // Redirect to the hexagon.html page
        window.location.href = "chat.html";

    }

    console.log(user_id);


    //
    //  Load Users
    //
    userref.orderByKey().once("value", function (snapshot_user_info) {

        userArray = snapshot_user_info.val();

    }).then(function () {

        //
        //  Load Conversations
        //
        convref.orderByChild("dateTime").on("child_added", function (snapshot) {       

            //
            //  Get conversations WITH participants
            //
            participantsref.orderByChild("conversation_id").equalTo(snapshot.key).on("child_added", function (snapshot_participants) {

                var convo_display = false;
                var convo_name = '';

                //
                //  Loop through conversations
                //
                $.each(snapshot_participants.val().user_id, function (key, current_user_id) {

                    //
                    //  Build the name of the convo
                    //
                    if (typeof(userArray[current_user_id]) !== "undefined"){

                        convo_name += userArray[current_user_id].displayName + ' ';

                    } else {

                        // convo_name += '[ANONYMOUS] ';
                    }

                    //
                    //  Display only the conversation the user is in
                    //
                    if (current_user_id == user_id) {

                        convo_display = true;

                    }
                    

                });

                if (convo_name.length < 3) {

                    convo_name = 'No one yet';

                }

                //convo_display = true;

                if (convo_display) {

                    //
                    //  Add to the list of Chats
                    //
                    //$("#chats").append('<li><a href="chat.html?conversation_id=' + snapshot.key + '">' + convo_name + ' </a></li>');

                    $("#chats").append('<li><a style="color:#fff; font-size: 18px; line-height: 25px;" href="#" onclick="javascript:LoadConvo(\'' + snapshot.key + '\')">' + convo_name + ' </a></li>');

                    

                }

            });            

        });

        });



    function LoadConvo( convoid ) {

        conversation_id = convoid;

        console.log(conversation_id);

        $("#chat_window").html("");        
        
        msgref.orderByChild("conversation_id").equalTo(convoid).on("child_added", function (msg_snap) {        
           
            current_user_id = msg_snap.val().user_id;
            

            //
            //  Build the name of the convo
            //
            if (typeof (userArray[current_user_id]) !== "undefined") {

                username = userArray[current_user_id].displayName + ' ';

            } else {

                username = '[ANONYMOUS] ';
            }

            if (msg_snap.val().user_id == user_id) {

                classname = 'self';
                avatar = 'images/uni.jpg';

            } else {

                classname = 'other';
                avatar = 'images/tri.jpg';

            };

           

            //
            //  Prepare the message
            //
            //message = '<li class="' + classname + '"><div class="avatar"><img src=' + avatar + ' draggable="false"/></div><div class="msg"><p>' + username + ' says: </p><p>' + msg_snap.val().text + ' </p><time>' + msg_snap.val().dateTime + '</time></div></li>';

            //
            //  Add the message to the view
            //
            //$(".chat").append(message);

            //
            //  Put the place holder for the message
            //
            var timeMsg = msg_snap.val().dateTime;

            var d = new Date(timeMsg);

            d.toLocaleString();


            $(".chat").append('<li class="' + classname + '"><div class="avatar"><img src=' + avatar + ' draggable="false"/></div><div class="msg"><p>' + username + ' says: </p><p  id="msg_' + msg_snap.key + '" >' + msg_snap.val().text + ' </p><time>' + d.toLocaleString() + '</time></div></li></li>');

            translate(msg_snap.val().text, msg_snap.val().language, classname, avatar, msg_snap.val().dateTime, username, msg_snap.key);



        });


        //
        //  Auto-scroll to the bottom
        //
       // window.scrollTo(0, document.body.scrollHeight);
       

    }

    
    
</script>


<div id="sidebar" class="page-sidebar">
    <div class="page-sidebar-scroll">

        <div class="sidebar-decoration"></div>
        <p class="sidebar-title">CHATS</p>
        <div class="sidebar-decoration"></div>

        <div class="sidebar-navigation">
            <ul id="chats" class="no-bullets">
            </ul>
        </div>

        <div class="sidebar-decoration"></div>
        <p class="sidebar-title">OPTIONS</p>
        <div class="sidebar-decoration"></div>

        <div class="page-notifications confirmation-notification">
            <a href="startconversation.html">
                <h4>New Conversation</h4>
                <p>Start a New Conversation</p>
            </a>
        </div>

        <div class="page-notifications warning-notification" id="logout" onclick="logout()">
            <a href="login.html">
                <h4>Logout</h4>
                <p>Logout from the current session</p>
            </a>
        </div>

        <div class="sidebar-decoration"></div>

        <p class="sidebar-copyright uppercase center-text">LetzChat &copy; Copyright 2017<br> All rights reserved</p>

    </div>
</div>

<style>
  
    #content {
        min-height: 100vh;
    }

</style>
