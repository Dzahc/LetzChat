 <script type="text/javascript" src="scripts/translate.js"></script>
<script>
    
    var participantsref = firebase.database().ref("participants");
    var userArray = [];
    var othersArray = [];
    var userref = firebase.database().ref("userId"); 
    var convref = firebase.database().ref("conversations"); 
    var msgref = firebase.database().ref("messages"); 

    var user = JSON.parse(localStorage.getItem("user"));

    var user_id = 'zAmBzW5Y8vZJmjl1VklGR8EQGzH2';

    //
    //  Load Users
    //
    userref.orderByKey().once("value", function (snapshot_user_info) {

        userArray = snapshot_user_info.val();

    }).then(function () {

        //
        //  Load Conversations
        //
        convref.orderByChild("dateTime").on("child_added", function (snapshot) {       

            //
            //  Get conversations WITH participants
            //
            participantsref.orderByChild("conversation_id").equalTo(snapshot.key).once("child_added", function (snapshot_participants) {

                var convo_display = false;
                var convo_name = '';

                //
                //  Loop through conversations
                //
                $.each(snapshot_participants.val().user_id, function (key, current_user_id) {

                    //
                    //  Build the name of the convo
                    //
                    if (typeof(userArray[current_user_id]) !== "undefined"){

                        convo_name += userArray[current_user_id].displayName + ' ';

                    } else {

                        // convo_name += '[ANONYMOUS] ';
                    }

                    //
                    //  Display only the conversation the user is in
                    //
                    if (current_user_id == user_id) {

                        convo_display = true;

                    }

                });

                if (convo_display) {

                    //
                    //  Add to the list of Chats
                    //
                    //$("#chats").append('<li><a href="chat.html?conversation_id=' + snapshot.key + '">' + convo_name + ' </a></li>');

                    $("#chats").append('<li><a style="color:#fff; font-size: 18px; line-height: 25px;" href="#" onclick="javascript:LoadConvo(\'' + snapshot.key + '\')">' + convo_name + ' </a></li>');

                    

                }

            }).then(function () {



            });            

        });

        });



    function LoadConvo( convoid ) {

        conversation_id = convoid;

        console.log(conversation_id);

        $("#chat_window").html("");        
        
        msgref.orderByChild("conversation_id").equalTo(convoid).on("child_added", function (msg_snap) {        
           
            current_user_id = msg_snap.val().user_id;

            //
            //  Build the name of the convo
            //
            if (typeof (userArray[current_user_id]) !== "undefined") {

                username = userArray[current_user_id].displayName + ' ';

            } else {

                username = '[ANONYMOUS] ';
            }

            if (msg_snap.val().user_id == user_id) {

                classname = 'self';
                avatar = 'images/uni.jpg';

            } else {

                classname = 'other';
                avatar = 'images/tri.jpg';

            };

           

            //
            //  Prepare the message
            //
            //message = '<li class="' + classname + '"><div class="avatar"><img src=' + avatar + ' draggable="false"/></div><div class="msg"><p>' + username + ' says: </p><p>' + msg_snap.val().text + ' </p><time>' + msg_snap.val().dateTime + '</time></div></li>';

            //
            //  Add the message to the view
            //
            //$(".chat").append(message);

            translate(msg_snap.val().text, msg_snap.val().language, classname, avatar, msg_snap.val().dateTime, username);

        });

       
        //
        //   SELECT messages from DB
        //
        /*ref.orderByChild("conversation_id").equalTo(convoid).on("child_added", function (snapshot) {

            msgref.orderByKey().equalTo(snapshot.val().user_id).once("child_added", function (snapshots) {

                count++;
                username = snapshots.val().displayName;
                userimage = snapshots.val().photo_id;               

                $("#chat_window").html("");

            }).then(function () {
                
                var index = { id: snapshot.key, text: snapshot.val().text, language: snapshot.val().language, uid: snapshot.val().user_id, user_id: username, date: snapshot.val().dateTime, picture_url: userimage }
                
                messageArray.push(index);
                messageArray.sort(function (a, b) {

                    //console.log(a.date, b.date);

                    if (a.date < b.date) {

                        return -1;

                    }

                    else if (a.date > b.date) {

                        return 1;

                    }

                    else {

                        return 0;

                    }

                });
                

                //
                //  Display the messages from the conversation
                //
                for (var i = 0; i < messageArray.length; i++) {

                    //
                    //  Build message
                    //
                    var message = '';
                    var classname = '';
                    var avatar = '';

                    if (messageArray[i].uid == localStorage.getItem("userId")) {

                        classname = 'self';

                    } else {

                        classname = 'other';

                    };

                    //
                    //  Compute Avatar
                    //
                    if (messageArray[i].picture_url) {

                        avatar = messageArray[i].picture_url;

                    } else {

                        if (classname == 'self') {

                            avatar = 'images/uni.jpg';

                        } else {

                            avatar = 'images/tri.jpg';

                        };

                    }

                    //
                    //  Prepare the message
                    //
                    message = '<li class="' + classname + '"><div class="avatar"><img src=' + avatar + ' draggable="false"/></div><div class="msg"><p>' + messageArray[i].user_id + ' says: </p><p>' + messageArray[i].text + ' </p><time>' + messageArray[i].date + '</time></div></li>';

                    //
                    //  Add the message to the view
                    //
                    $(".chat").append(message);

                    /////////////////////////////////////////////////////////////
                    //  Hard-coded TESTS - Please don't forget to remove this
                    //
                    message = '<li class="self"><div class="avatar"><img src=' + 'images/uni.jpg' + ' draggable="false"/></div><div class="msg"><p>' + 'Flo' + ' says: </p><p>' + 'This is my first message ever' + ' </p><time>' + '12:12 1/1/2017' + '</time></div></li>';

                    //
                    //  Add the message to the view
                    //
                    $(".chat").append(message);
                    //////////////////////////////////////////////////////////////

                }


            }).then(function () {

                //
                //  Auto-scroll to the bottom
                //
                window.scrollTo(0, document.body.scrollHeight);

            });
        });*/

    }

    
    
</script>


<div id="sidebar" class="page-sidebar">
    <div class="page-sidebar-scroll">

        <div class="sidebar-decoration"></div>
        <p class="sidebar-title">CHATS</p>
        <div class="sidebar-decoration"></div>

        <div class="sidebar-navigation">
            <ul id="chats" class="no-bullets">
            </ul>
        </div>

        <div class="sidebar-decoration"></div>
        <p class="sidebar-title">OPTIONS</p>
        <div class="sidebar-decoration"></div>

        <div class="page-notifications information-notification">
            <h4>Settings</h4>
            <p>Change all your personal info</p>
        </div>

        <div class="page-notifications warning-notification" id="logout" onclick="logout()">
            <a href="login.html">
                <h4>Logout</h4>
                <p>Logout from the current session</p>
            </a>
        </div>

        <div class="sidebar-decoration"></div>

        <p class="sidebar-copyright uppercase center-text">LetzChat &copy; Copyright 2017<br> All rights reserved</p>

    </div>
</div>

<style>
  
    #content {
        min-height: 100vh;
    }

</style>
